---
title: "SAT - HW 10 Template"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F)
library("tidyverse")
library("rstan") # observe startup messages
library("shinystan")
library("bayesplot")
library("matrixStats")
library("gridExtra")
library("mosaic")
options(mc.cores = parallel::detectCores()) #want to run the chains in parallel
rstan_options(auto_write = TRUE) #write a complied version to the disk 

sat_data <- read_csv('Guber1999data.csv')

```



### General Instructions
- DO echo your R code in your output.
- Upload in your .Rmd, .stan, and .html files to Schoology.  Do not zip.
- Load libraries and data in this section.  
- Put the code and text in their respective sections.

```{r}
# Normalize in R, transform back in Stan
sat_data <- mutate(sat_data, z_spend = as.numeric(scale(sat_data$Spend)), 
                   z_ptake = as.numeric(scale(sat_data$PrcntTake)), 
                   z_sat = as.numeric(scale(sat_data$SATT)))
# Input for Stan
sat.data <- list(J=2,N=nrow(sat_data),
                 mspend = mean(sat_data$Spend), mptake = mean(sat_data$PrcntTake), msat = mean(sat_data$SATT),
                 sspend = sd(sat_data$Spend),sptake = sd(sat_data$PrcntTake),ssat = sd(sat_data$SATT),
                 z_spend = sat_data$z_spend,
                 z_ptake = sat_data$z_ptake,
                 z_sat = sat_data$z_sat)

fit <- stan(file = "SAT.stan",data = sat.data,seed = 42)

launch_shinystan(as.shinystan(fit))

```

### EDA
Include three scatterplots of SATT by Spend, SATT by PercntTake, and Spend by PercntTake, and comment on what you see. Calculate the correlation of Spend and PercntTake and comment on its value.

```{r}
ggplot(data=sat_data)+
  geom_point(mapping = aes(x=Spend,y=SATT))
ggplot(data=sat_data)+
  geom_point(mapping = aes(x=StuTeaRat,y=SATT))
ggplot(data=sat_data)+
  geom_point(mapping = aes(x=PrcntTake,y=SATT))
ggplot(data=sat_data)+
  geom_point(mapping = aes(x=Salary,y=SATT))
ggplot(data=sat_data)+
  geom_point(mapping = aes(x=Spend,y=PrcntTake))

corr_PctTake_Spend=cor(sat_data$Spend,sat_data$PrcntTake)
corr_SATT_Spend = cor(sat_data$Spend,sat_data$SATT)
corr_SATT_PctTake = cor(sat_data$PrcntTake,sat_data$SATT)
```


### Model Description

I'd like you to implement two models.  Use a generalized $t$ distribution for both the likelihood and the priors on all of the slope parameters (code the interaction).  One model does NOT use shrinkage for the slope parameters (Model 1), and one does (Model 2).  Describe your two models in this section, noting the prior distributions you will use.  If you know how to use Latex, please use it to write your distributions and parameters.  Do not put the SAT bounds in your model, it will be hard to do prior predictive checks.



##Model 1

This model doesn't use shrinkage. The model prior has a linear combination of 
 $z_{y_{i}\sim student-t(z_\nu, z_{\beta_{0}{+z_{\beta_{1}}*Spend_{i}+z_{\beta_{2}}*PrcntTake_{i}+z_{\beta_{3}}*Spend_{i}*PrcntTake_{i}, z_\sigma)$, where $i = 1,2,3,...,50$ indicating each subject; $z_\nu \sim e^{(1/30)}$, $z_\sigma \sim Normal(0,1)$.

```{r}
sat_data <- mutate(sat_data, spend_pct = Spend*PrcntTake) #interaction variable created

#normalize the newly created variable:
sat_data <- mutate(sat_data, z_spend_pct = as.numeric(scale(Spend*PrcntTake))) 

# Input for Stan
sat.data <- list(J=3, N=nrow(sat_data),
                 mint = mean(sat_data$spend_pct),
                 mspend = mean(sat_data$Spend), mptake = mean(sat_data$PrcntTake), msat = mean(sat_data$SATT),
                 sspend = sd(sat_data$Spend),sptake = sd(sat_data$PrcntTake),ssat = sd(sat_data$SATT), sint = sd(sat_data$spend_pct),
                 z_spend = sat_data$z_spend,
                 z_ptake = sat_data$z_ptake,
                 z_int = sat_data$z_spend_pct,
                 z_sat = sat_data$z_sat)
fit.m1 <- stan(file = "model1_noshrink.stan",data = sat.data,seed = 42)

launch_shinystan(as.shinystan(fit.m1))

```

### Prior Predictive Checks

Do a prior preditive check for Model 1 that seems reasonable and explain WHY you chose it and what your visual describes.  Just do a single plot, but make sure it's clear to me that you fully understand what it is saying.

We choose a bar chart to display the generated fake data with its mean highlighted which is about 980. The range of scores is reasonable with a wide range of value as the mean of SAT scores.

```{r}
sat.pri.data <- list(J=3, N=nrow(sat_data),
                     spend = sat_data$Spend, 
                     ptake = sat_data$PrcntTake,
                     inter = sat_data$spend_pct,
                 mint = mean(sat_data$spend_pct),
                 mspend = mean(sat_data$Spend),
                 mptake = mean(sat_data$PrcntTake), 
                 msat = mean(sat_data$SATT),
                 sspend = sd(sat_data$Spend),
                 sptake = sd(sat_data$PrcntTake),
                 ssat = sd(sat_data$SATT), 
                 sint = sd(sat_data$spend_pct))

fit.prior.m1 <- stan(file = 'model1_pri_noshrink.stan', data = sat.pri.data, seed = 21,control = list(adapt_delta = 0.999))
launch_shinystan(as.shinystan(fit.prior.m1))

set.seed(21)
fake.data.stan <- as.matrix(as.data.frame(fit.prior.m1) %>% select(contains("y_fake")) %>% sample_n(size = 100))


#prior predictive check for the fake data vs. real data
ppc_stat(sat_data$SATT, fake.data.stan)
# ppc_stat(sat_data$SATT, fake.data.stan, stat = "sd")
# ppc_stat(sat_data$SATT, fake.data.stan, stat = "min")
# ppc_dens_overlay(sat_data$SATT, fake.data.stan) 
# samples <- as.data.frame(fit.prior.m1)%>%
#   sample_n(size = 30)%>%
#   select(contains("y_fake"))
#ppc_dens_overlay(y=as.numeric(sat_data$SATT), yrep = as.matrix(samples))
```


## Model 2

This model is with shrinkage. The model prior has a linear combination of 
$z_{y_{i}\sim student-t(z_\nu, z_{\beta_{0}{+z_{\beta_{1}}*z_{Spend_{i}}+z_{\beta_{2}}*z_{PrcntTake_{i}}+z_{\beta_{3}}*z_{Spend_{i}*PrcntTake_{i}}, z_\sigma)$, where $i = 1,2,3,...,50$ indicating each subject; $z_\nu \sim e^{(1/30)}$, $z_\sigma \sim Normal(0,1)$, $z_{\beta_{0,1,2,3}}\sim student-t(10, \mu, \sigma)$ where $\mu\sim Normal(0,1)$, $\sigma\sim Normal(0,1)$. We choose 10 for $nu$ for $z_\beta$'s because we want theem to have some thickness to the tails but not too thick. We choose standard normal distributions for $z_\beta$'s $\mu$ and Half-Normal for $\sigma$ because although $z_\beta$'s are standardized, for practice purpose we still give them a hyper distribution.

```{r}
# Input for Stan
sat.data <- list(J=3, hypers = c(0,0.5,1,0.5),
                 N=nrow(sat_data),
                 spend = sat_data$Spend, 
                 ptake = sat_data$PrcntTake,
                 inter = sat_data$spend_pct,
                 mint = mean(sat_data$spend_pct),
                 mspend = mean(sat_data$Spend), 
                 mptake = mean(sat_data$PrcntTake), 
                 msat = mean(sat_data$SATT),
                 sspend = sd(sat_data$Spend),
                 sptake = sd(sat_data$PrcntTake),
                 ssat = sd(sat_data$SATT), 
                 sint = sd(sat_data$spend_pct),
                 z_spend = sat_data$z_spend,
                 z_ptake = sat_data$z_ptake,
                 z_int = sat_data$z_spend_pct,
                 z_sat = sat_data$z_sat)
fit.m2 <- stan(file = "model2_shrink.stan",data = sat.data, seed = 42, control = list(adapt_delta = 0.999))

launch_shinystan(as.shinystan(fit.m2))

```

### Hierarchical Modeling
Fit both models using the standardized data and then transform back to parameters on the original scale. 


### Model Diagnostics
Just write a sentence or two describing what you noticed in Shinystan when you ran the models. Remember to increase the number of digits in Stan's output.


### Posterior Predictive Checks
Use the same check you used for the prior predictive check and comment.


### Conclusions
Answer the following questions, using credible intervals as your evidence.  

1. (Model 1) Is there evidence that the slope parameters are not zero?  

2. (Model 1) What inference can you make about the effect of Spend and PercntTake on SATT? Interpret this in the context of the interaction.

3. How is Model 2 different from Model 1?  Can you explain why?  Do you have any questions about your results?





